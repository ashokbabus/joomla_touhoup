/*------------------------------------------------------------------------
# Copyright (C) 2005-2012 WebxSolution Ltd. All Rights Reserved.
# @license - GPLv2.0
# Author: WebxSolution Ltd
# Websites:  http://www.webxsolution.com
# Terms of Use: An extension that is derived from the JoomlaCK editor will only be allowed under the following conditions: http://joomlackeditor.com/terms-of-use
# ------------------------------------------------------------------------*/ 
CKEDITOR.dialog.add("jtreelink",function(a){var b=/^(index.php.*)/,c=/^(_(?:self|top|parent|blank))$/,d="",e="notSet";var f=a.plugins.jtreelink.path;var g=a.config.baseHref;var h=function(){var b=this.getDialog(),c=b.getContentElement("target","popupFeatures"),d=b.getContentElement("target","linkTargetName"),e=b.getContentElement("target","relModaltext"),f=this.getValue(),g=b.getContentElement("target","JoomlaModelFeatures"),h=b.getContentElement("target","useJoomlaTemplateBox");if(!c||!d)return;c=c.getElement();c.hide();d.setValue(f);switch(f){case"frame":d.setLabel(a.lang.jtreelink.targetFrameName);d.getElement().show();e.getElement().show();g.getElement().show();h.getElement().show();break;case"popup":g.getElement().hide();c.show();d.setLabel(a.lang.jtreelink.targetPopupName);d.getElement().show();e.getElement().hide();h.getElement().hide();break;default:d.setValue(f);d.getElement().hide();e.getElement().hide();g.getElement().hide();h.getElement().hide();break}};var i=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/;var j=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var k=/\{handler:\s*'iframe'\s*,\s*size:\s*\{x:\s*(\d+?)\s*,\s*y:\s*(\d+?)\}\}/i;var l=function(a,e){var f=e&&(e.getAttribute("_cke_saved_href")||e.getAttribute("href"))||"",g=a.document,h={};if(f&&(d=f.match(b))){document.ckadminForm.url.value=d[1].replace("&tmpl=component","")}if(e){var l=e.getAttribute("target");h.target={};h.adv={};if(!l){var m=e.getAttribute("_cke_pa_onclick")||e.getAttribute("onclick"),n=m&&m.match(i);if(n){h.target.type="popup";h.target.name=n[1];var o;while(o=j.exec(n[2])){if(o[2]=="yes"||o[2]=="1")h.target[o[1]]=true;else if(isFinite(o[2]))h.target[o[1]]=o[2]}}}else{var p=l.match(c);if(p)h.target.type=h.target.name=l;else{h.target.type="frame";h.target.name=l}}var q=e.getAttribute("rel");h.target.rel={};h.target.modalchecked=true;if(h.target.type=="frame")h.target.modalchecked=false;if(e.$.href.indexOf("&tmpl=component")!=-1)h.target.useJoomlaTemplate=false;else h.target.useJoomlaTemplate=true;if(q){var r=e.getAttribute("class");var s=r&&r.match(/(?:^|\s)([\w\d]*)$/);if(s)h.target.rel.classname=s[1];var t=q.match(k);if(t){if(t[1])h.target.rel.width=t[1];if(t[2])h.target.rel.height=t[2];h.target.modalchecked=true}else h.target.modalchecked=false;h.target.type="frame"}var u=this;var v=function(a,b){var c=e.getAttribute(b);if(c!==null)h.adv[a]=c||""};v("advId","id");v("advLangDir","dir");v("advAccessKey","accessKey");v("advName","name");v("advLangCode","lang");v("advTabIndex","tabindex");v("advTitle","title");v("advContentType","type");v("advCSSClasses","class");v("advCharset","charset");v("advStyles","style");document.ckadminForm.text.value=e.getText();document.ckadminForm.title.value=e.getAttribute("title")}this._.selectedElement=e;return h};var m=function(a,b){if(b[a])this.setValue(b[a][this.id]||"")};var n=function(a){return m.call(this,"target",a)};var o=function(a){return m.call(this,"adv",a)};var p=function(a,b){if(!b[a])b[a]={};b[a][this.id]=this.getValue()||""};var q=function(a){return p.call(this,"target",a)};var r=function(a){return p.call(this,"adv",a)};var s=a.lang.common,t=a.lang.jtreelink;return{title:"",minWidth:590,minHeight:330,contents:[{id:"info",label:t.info,title:t.info,padding:0,elements:[{type:"text",id:"placer",style:"display:none;"},{type:"html",html:'<div id="jtree-content_tree" style="height:260px;width:590px;overflow:auto;border:1px solid #CCC;"></div>'+'<div id="jtree-linkinfo-tree" style="margin-top:3px;border:1px solid #CCC;padding:3px">'+'<form name="ckadminForm" action="#" onSubmit="return false;">'+'<table style="height:40px;width:100%;">'+" <tr>"+"<td>Text</td>"+'<td><input type="text" name="text" id="ctext" value="" size="30" style="border:1px solid #CCC;" /></td>'+"<td>Title</td>"+'<td><input type="text" name="title" id="ctitle"  value="" size="30" style="border:1px solid #CCC;"/></td>'+"</tr>"+"<tr>"+"<td>URL</td>"+'<td colspan="3"><input type="text" name="url" id="url"  value="" size="30" style="border:1px solid #CCC;"/></td>'+"</tr>"+"</table>"+"</form>"+"</div>"}]},{id:"target",label:t.target,title:t.target,elements:[{type:"hbox",widths:["50%","50%"],children:[{type:"select",id:"linkTargetType",label:s.target,"default":"notSet",style:"width : 100%;",items:[[s.notSet,"notSet"],[t.targetFrame,"frame"],[t.targetPopup,"popup"],[s.targetNew,"_blank"],[s.targetTop,"_top"],[s.targetSelf,"_self"],[s.targetParent,"_parent"]],onChange:h,setup:function(a){if(a.target)this.setValue(a.target.type);h.call(this)},commit:function(a){if(!a.target)a.target={};a.target.type=this.getValue()}},{type:"text",id:"linkTargetName",label:t.targetFrameName,"default":"",setup:function(a){if(a.target)this.setValue(a.target.name)},commit:function(a){if(!a.target)a.target={};a.target.name=this.getValue().replace(/\W/gi,"")}}]},{type:"hbox",widths:["25%","25%","25%","25%"],id:"JoomlaModelFeatures",height:"40",children:[{type:"checkbox",id:"modelcheckbox",label:"Use Joomla Modal","default":"checked",onClick:function(){var a=this.getDialog();var b=a.getContentElement("target","relHeight"),c=a.getContentElement("target","relWidth"),d=a.getContentElement("target","relClass"),e=a.getContentElement("target","relModaltext"),f=a.getContentElement("target","useJoomlaTemplateBox");if(this.getValue()){b.getElement().show();c.getElement().show();d.getElement().show();e.getElement().show();f.getElement().show()}else{b.getElement().hide();c.getElement().hide();d.getElement().hide();e.getElement().hide();f.getElement().hide()}},setup:function(a){if(a.target){var b=this.getDialog();var c=b.getContentElement("target","relHeight"),d=b.getContentElement("target","relWidth"),e=b.getContentElement("target","relClass"),f=b.getContentElement("target","relModaltext"),g=b.getContentElement("target","useJoomlaTemplateBox");var h=g.getElement(),i=f.getElement(),j=this.getElement();if(a.target.modalchecked){c.getElement().show();d.getElement().show();e.getElement().show();if(j.getStyle("display")=="block"){h.show();i.show()}}else{c.getElement().hide();d.getElement().hide();e.getElement().hide();if(j.getStyle("display")=="block"){h.hide();i.hide()}}this.setValue(a.target.modalchecked)}},commit:function(a){if(!a.target)a.target={};a.target.modalchecked=this.getValue()}},{type:"text",id:"relClass",label:"Classname","default":"modal",setup:function(a){if(a.target&&a.target.rel)this.setValue(a.target.rel.classname||"modal")},commit:function(a){if(!a.target.rel)a.target.rel={};a.target.rel.classname=this.getValue()}},{type:"text",id:"relHeight",label:"Height","default":"550",setup:function(a){if(a.target&&a.target.rel)this.setValue(a.target.rel.height||550)},commit:function(a){if(!a.target.rel)a.target.rel={};a.target.rel.height=this.getValue().replace(/\W/gi,"")}},{type:"text",id:"relWidth",label:"Width","default":"450",setup:function(a){if(a.target&&a.target)this.setValue(a.target.rel.width||450)},commit:function(a){if(!a.target.rel)a.target.rel={};a.target.rel.width=this.getValue().replace(/\W/gi,"")}}]},{type:"vbox",id:"useJoomlaTemplateBox",height:"40",children:[{type:"checkbox",id:"useJoomlaTemplate",label:"Use Joomla Template",onClick:function(){},setup:function(a){if(a.target){this.setValue(a.target.useJoomlaTemplate)}},commit:function(a){if(!a.target)a.target={};a.target.useJoomlaTemplate=this.getValue()}}]},{type:"vbox",id:"relModaltext",children:[{type:"html",html:'<div style="position: relative; height: 167px;"><span style=" position: absolute; bottom:0px; font-style:italic;"><span style="font-weight:bold;">Please note</span>: this functionality requires Joomla\'s Modal library to be loaded in order for this functionality to work. <br/>Please <a href="http://www.joomlackeditor.com/component/jdownloads/viewdownload/17-joomla-plugins/51-jck-modal-plugin" target="_blank" style="color: blue; text-decoration: underline; cursor: pointer;">click here</a> to view our solution.</span></div>'}]},{type:"vbox",width:260,align:"center",padding:2,id:"popupFeatures",children:[{type:"fieldset",label:t.popupFeatures,children:[{type:"hbox",children:[{type:"checkbox",id:"resizable",label:t.popupResizable,setup:n,commit:q},{type:"checkbox",id:"status",label:t.popupStatusBar,setup:n,commit:q}]},{type:"hbox",children:[{type:"checkbox",id:"location",label:t.popupLocationBar,setup:n,commit:q},{type:"checkbox",id:"toolbar",label:t.popupToolbar,setup:n,commit:q}]},{type:"hbox",children:[{type:"checkbox",id:"menubar",label:t.popupMenuBar,setup:n,commit:q},{type:"checkbox",id:"fullscreen",label:t.popupFullScreen,setup:n,commit:q}]},{type:"hbox",children:[{type:"checkbox",id:"scrollbars",label:t.popupScrollBars,setup:n,commit:q},{type:"checkbox",id:"dependent",label:t.popupDependent,setup:n,commit:q}]},{type:"hbox",children:[{type:"text",widths:["30%","70%"],labelLayout:"horizontal",label:t.popupWidth,id:"width",setup:n,commit:q},{type:"text",labelLayout:"horizontal",widths:["55%","45%"],label:t.popupLeft,id:"left",setup:n,commit:q}]},{type:"hbox",children:[{type:"text",labelLayout:"horizontal",widths:["30%","70%"],label:t.popupHeight,id:"height",setup:n,commit:q},{type:"text",labelLayout:"horizontal",label:t.popupTop,widths:["55%","45%"],id:"top",setup:n,commit:q}]}]}]}]},{id:"advanced",label:t.advanced,title:t.advanced,elements:[{type:"vbox",padding:1,children:[{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",id:"advId",label:t.id,setup:o,commit:r},{type:"select",id:"advLangDir",label:t.langDir,"default":"",style:"width:110px",items:[[s.notSet,""],[t.langDirLTR,"ltr"],[t.langDirRTL,"rtl"]],setup:o,commit:r},{type:"text",id:"advAccessKey",width:"80px",label:t.acccessKey,maxLength:1,setup:o,commit:r}]},{type:"hbox",widths:["45%","35%","20%"],children:[{type:"text",label:t.name,id:"advName",setup:o,commit:r},{type:"text",label:t.langCode,id:"advLangCode",width:"110px","default":"",setup:o,commit:r},{type:"text",label:t.tabIndex,id:"advTabIndex",width:"80px",maxLength:5,setup:o,commit:r}]}]},{type:"vbox",padding:1,children:[{type:"vbox",children:[{type:"text",label:t.advisoryContentType,"default":"",id:"advContentType",setup:o,commit:r}]},{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:t.cssClasses,"default":"",id:"advCSSClasses",setup:o,commit:r},{type:"text",label:t.charset,"default":"",id:"advCharset",setup:o,commit:r}]},{type:"hbox",children:[{type:"text",label:t.styles,"default":"",id:"advStyles",setup:o,commit:r}]}]}]}],onLoad:function(){dialog=this;a=this.getParentEditor();if(!a.config.jtreelinkShowAdvancedTab)this.hidePage("advanced");if(!a.config.jtreelinkShowTargetTab)this.hidePage("target");var b="",c=new MooTreeControl({div:"jtree-content_tree",mode:"files",grid:true,theme:f+"images/mootree.gif",loader:{icon:f+"images/mootree_loader.gif",text:"Loading...",color:"#a0a0a0"},onSelect:function(a,b){if(a.data.url&&a.data.selectable=="true"){document.ckadminForm.url.value=a.data.url;document.ckadminForm.text.value=a.text;document.ckadminForm.title.value=a.text}}},{text:"Links",open:true});c.root.load(f+"dialogs/initialize.php?client="+a.config.client)},onShow:function(){var a=this.getParentEditor(),b=a.getSelection(),c=null;link=c&&c.getAscendant("a");var d=CKEDITOR.plugins.link;if((c=d.getSelectedLink(a))&&c.hasAttribute("href")){b.selectElement(c)}else{c=null}document.ckadminForm.url.value="";document.ckadminForm.text.value="";document.ckadminForm.title.value="";this.setupContent(l.apply(this,[a,c]))},onOk:function(){var a=this.getParentEditor();var b=document.ckadminForm.url.value||false;var c=document.ckadminForm.text.value;var d=document.ckadminForm.title.value;var f={href:b,title:d},g={},h=[];this.commitContent(g);if(g.target){if(g.target.type=="popup"){var i=["window.open(this.href, '",g.target.name||"","', '"];var j=["resizable","status","location","toolbar","menubar","fullscreen","scrollbars","dependent"];var k=j.length;var l=function(a){if(g.target[a])j.push(a+"="+g.target[a])};for(var m=0;m<k;m++)j[m]=j[m]+(g.target[j[m]]?"=yes":"=no");l("width");l("left");l("height");l("top");i.push(j.join(","),"'); return false;");f["_cke_pa_onclick"]=i.join("");h.push("target");h.push("rel")}else{if(g.target.type!=e&&g.target.name){f.target=g.target.name}else h.push("target");h.push("_cke_pa_onclick","onclick")}}if(g.adv){var n=function(a,b){var c=g.adv[a];if(c)f[b]=c;else{if(b!="class")h.push(b)}};if(this._.selectedElement)n("advId","id");n("advLangDir","dir");n("advAccessKey","accessKey");n("advName","name");n("advLangCode","lang");n("advTabIndex","tabindex");n("advContentType","type");n("advCSSClasses","class");n("advCharset","charset");n("advStyles","style")}if(g.target&&g.target.type=="frame"&&g.target.modalchecked){var o="{handler: 'iframe' , size: {x:"+g.target.rel.width+", y:"+g.target.rel.height+"}}";f["rel"]=o;f["class"]=f["class"]?f["class"]+" "+g.target.rel.classname:g.target.rel.classname;if(!g.target.useJoomlaTemplate){f["href"]+="&tmpl=component"}else f["href"]=f["href"].replace("&tmpl=component","")}else{h.push("rel");f["href"]=f["href"].replace("&tmpl=component","")}if(!this._.selectedElement){var p=a.getSelection(),q=p.getRanges(true);if(q.length==1&&q[0].collapsed){var r=new CKEDITOR.dom.text(c,a.document);q[0].insertNode(r);q[0].selectNodeContents(r);p.selectRanges(q)}var s=new CKEDITOR.style({element:"a",attributes:f});s.type=CKEDITOR.STYLE_INLINE;s.apply(a.document)}else{var t=this._.selectedElement;var u=false;var v=t.getChildren();for(var m=0,w=v.count();m<w;m++){var x=v.getItem(m);if(x.type==CKEDITOR.NODE_ELEMENT&&x.is("img")){u=true;break}}if(!u)t.setText(c);f._cke_saved_href=f.href;t.setAttributes(f);t.removeAttributes(h);if(g.target&&(g.target.type!="frame"||g.target.type=="frame"&&!g.target.modalchecked)){var y=g.target.rel.classname;if(y&&t.hasClass(y)){t.removeClass(y)}}if(g.target.type!=e&&g.target.name)f.target=g.target.name;else delete this._.selectedElement}}}})