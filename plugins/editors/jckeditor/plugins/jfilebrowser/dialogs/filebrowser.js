/*------------------------------------------------------------------------
# Copyright (C) 2005-2012 WebxSolution Ltd. All Rights Reserved.
# @license - GPLv2.0
# Author: WebxSolution Ltd
# Websites:  http://www.webxsolution.com
# Terms of Use: An extension that is derived from the JoomlaCK editor will only be allowed under the following conditions: http://joomlackeditor.com/terms-of-use
# ------------------------------------------------------------------------*/ 
(function(){CKEDITOR.dialog.add("filebrowser",function(a){var b,a,c=false,d=CKEDITOR.plugins.getPath("jfilebrowser")+"images/",e=/[^\/]+\/$/,f=/[\\\/:\*\?"<>\|]/,g=new RegExp("^(?:"+a.config.filebrowser_icons.replace(/,/g,"|")+")$","i"),h=[];this.OnUploadCompleted=function(c,d,e){if(c==a.plugins.jfilebrowser.ERROR_NONE||c==a.plugins.jfilebrowser.ERROR_UPLOADEDFILERENAMED)v(b.type,b.path);b.getContentElement("tab1","inputFile").reset();if(CKEDITOR.env.gecko){CKEDITOR.tools.setTimeout(function(){b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client)},500,this)}else b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client);b.getContentElement("tab1","uploadFile").enable();var f=CKEDITOR.document.getById(b.getContentElement("tab1","inputFile")._.labelId);f.setHtml(a.lang.filebrowser.uploadTip);a.plugins.jfilebrowser._detectError(a,c,e,d)};var i={id:"createFolder",label:a.lang.filebrowser.folderCreate,title:a.lang.filebrowser.folderCreateTip,accessKey:"C",type:"button",disabled:false,onClick:function(){var c;while(true){c=prompt(a.lang.filebrowser.folderNew,"");if(c==null)return;else if(c.length==0)alert(a.lang.filebrowser.folderEmpty);else if(f.test(c))alert(a.lang.filebrowser.folderInvalidChar);else break}x(b.type,b.path,c)}};var j=function(a,b,c,d){this.name=a;this.url=b;this.allowedExtensions=c.toLowerCase().split(",");this.deniedExtensions=d.toLowerCase().split(",");this.isExtensionAllowed=function(a){a=a.toLowerCase();return(!this.deniedExtensions.length||CKEDITOR.tools.indexOf(this.deniedExtensions,a)==-1)&&(!this.allowedExtensions.length||CKEDITOR.tools.indexOf(this.allowedExtensions,a)!==-1)}};var k=function(a){return a.substr(a.lastIndexOf(".")+1).toLowerCase()};var l=function(a){var b=k(a);if(g.test(b))return b;else return"default.icon"};var m=function(){b.getContentElement("tab1","folders").getElement().setHtml("")};var n=function(){b.getContentElement("tab1","resourceslist").getElement().setHtml("")};var o=function(a,c){var d,f,g=new CKEDITOR.dom.element("table"),h=new CKEDITOR.dom.element("tbody");f=new CKEDITOR.dom.element("tr");d=new CKEDITOR.dom.element("td");d.appendText("..");d.addClass("cke_folderUp");d.on("click",function(a){var b=this.path.replace(e,"");if(b!="/")w(this.type,b.replace(e,""));else m();v(this.type,b)},b,{});f.append(d);h.append(f);for(var i=0;i<a.length;i++){f=new CKEDITOR.dom.element("tr");d=new CKEDITOR.dom.element("td");d.appendText(a[i]);d.addClass(i==c?"cke_folderOpened":"cke_folder");d.on("click",function(a){o(a.listenerData.folders,a.listenerData.folder);v(this.type,this.path.replace(e,"")+a.listenerData.folders[a.listenerData.folder]+"/")},b,{folders:a,folder:i});f.append(d);h.append(f)}m();g.setStyle("width","100%");g.append(h);b.getContentElement("tab1","folders").getElement().append(g)};var p=function(a){return parseInt(a.selectSingleNode("Connector/Error/@number").value)};var q=function(a){var b=a.selectSingleNode("Connector/Error/@text");if(!b)return"";return b.value};var r=function(d){if(a.plugins.jfilebrowser._detectError(a,p(d),q(d)))return;var e,f=b.getContentElement("tab1","cmbResourceType"),g=d.selectNodes("Connector/ResourceTypes/ResourceType");f.clear();b.resourceTypes={};for(var h=0;h<g.length;h++){e=g[h].attributes.getNamedItem("name").value;b.resourceTypes[e]=new j(e,g[h].attributes.getNamedItem("url").value,g[h].attributes.getNamedItem("allowedExtensions").value,g[h].attributes.getNamedItem("deniedExtensions").value);f.add(e)}c=true;v(g[0].attributes.getNamedItem("name").value,"/")};var s=function(c){if(a.plugins.jfilebrowser._detectError(a,p(c),q(c)))return;v(b.type,b.path)};var t=function(b){if(a.plugins.jfilebrowser._detectError(a,p(b),q(b)))return;var c=b.selectSingleNode("Connector/CurrentFolder"),d=b.selectNodes("Connector/Folders/Folder"),e=[];for(var f=0;f<d.length;f++)e.push(d[f].attributes.getNamedItem("name").value);o(e,c)};var u=function(c){if(a.plugins.jfilebrowser._detectError(a,p(c),q(c)))return;var e,f,g,i,j,k,m=new CKEDITOR.dom.element("table"),r=new CKEDITOR.dom.element("tbody"),s=c.selectNodes("Connector/Folders/Folder"),t=c.selectSingleNode("Connector/CurrentFolder"),u=c.selectSingleNode("Connector"),w=[],x=[];b.type=u.attributes.getNamedItem("resourceType").value;b.url=t.attributes.getNamedItem("url").value;b.path=t.attributes.getNamedItem("path").value;if(CKEDITOR.env.ie){h.clear();b.getContentElement("tab1","resourceslist").getElement().setStyle("overflow-y","scroll")}else{m.setStyle("display","table-cell");m.setStyle("width","100%");m.setStyle("float","left")}b.getContentElement("tab1","resourceslist").getElement().setStyle("background-color","#FFFFFF");b.getContentElement("tab1","resourceslist").getElement().setStyle("padding","10px");CKEDITOR.document.getById("cke_actualFolder").setHtml(b.path);m.setAttribute("id","tableFiles");for(var y=0;y<s.length;y++){x.push(s[y].attributes.getNamedItem("name").value);g=new CKEDITOR.dom.element("tr");f=new CKEDITOR.dom.element("td");f.appendText(x[y]);f.setAttribute("colSpan",3);f.addClass("cke_folder");g.append(f);g.on("click",function(a){o(a.listenerData.folders,a.listenerData.folder);v(this.type,this.path+a.listenerData.folders[a.listenerData.folder]+"/")},b,{folder:y,folders:x});r.append(g)}s=c.selectNodes("Connector/Files/File");for(var y=0;y<s.length;y++){w.push(s[y].attributes.getNamedItem("name").value);g=new CKEDITOR.dom.element("tr");f=new CKEDITOR.dom.element("td");e=new CKEDITOR.dom.element("img");e.setAttribute("src",CKEDITOR.getUrl(d+"icons/"+l(w[y])+".gif"));k=new CKEDITOR.dom.element("a");k.setAttribute("href","javascript:void();");var z=b.resourceTypes[b.type].url+b.path.substr(1)+w[y];var A=z.match(/.+\.(gif|jpg|png)$/i)?true:false;if(A){i=new CKEDITOR.dom.element("span");j=new CKEDITOR.dom.element("img");j.setAttributes({id:w[y].replace(/(\.gif|\.jpg|\.png)$/i,""),alt:"",title:"",src:a.config.baseHref+z,border:"0"});i.setAttribute("id","previewImg");i.append(j)}f.setStyle("width","20px");f.setStyle("text-align","center");k.append(e);if(A)k.append(i);f.append(k);g.append(f);f=new CKEDITOR.dom.element("td");f.appendText(w[y]);f.setStyle("vertical-align","middle");f.setStyle("width","450px");g.append(f);f=new CKEDITOR.dom.element("td");f.appendText(s[y].attributes.getNamedItem("size").value+"KB");f.setStyle("vertical-align","middle");f.setStyle("width","50px");g.append(f);g.on("click",function(c){var d=this.resourceTypes[this.type].url+this.path.substr(1)+c.listenerData.file;a.fire("fileSelected",{url:d},a);b.hide()},b,{file:w[y]});r.append(g)}n();m.append(r);b.getContentElement("tab1","resourceslist").getElement().append(m);if(CKEDITOR.env.ie)h.process(50);b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client)};var v=function(b,c){CKEDITOR.ajax.loadXml(a.plugins.jfilebrowser._commandUrl(a,"GetFoldersAndFiles",{type:b,currentFolder:c}),u)};var w=function(b,c){CKEDITOR.ajax.loadXml(a.plugins.jfilebrowser._commandUrl(a,"GetFolders",{type:b,currentFolder:c}),t)};var x=function(b,c,d){CKEDITOR.ajax.loadXml(a.plugins.jfilebrowser._commandUrl(a,"CreateFolder",{type:b,currentFolder:c,newFolderName:d}),s)};return{title:a.lang.filebrowser.title,minWidth:"680",minHeight:"428",onLoad:function(){b=this;a=this.getParentEditor();var c=CKEDITOR.document.getHead();c.append(CKEDITOR.document.createElement("link",{attributes:{type:"text/css",rel:"stylesheet",href:a.config.baseHref+"plugins/editors/jckeditor/plugins/jfilebrowser/dialogs/filebrowser.css"}}));if(CKEDITOR.env.ie){CKEDITOR.tools.extend(h,{process:function(a){var b=CKEDITOR.document.getById("tableFiles");var c=b.getElementsByTag("span");var d=0;if(CKEDITOR.env.ie){d=1}var e=null;var f=null;var g=null;for(var h=0;h<c.count();h++){e=c.getItem(h);g=new Image;e=e.$;f=e.childNodes.item(0);g.name=f.id;g.src=f.src;var i=g.height;var j=g.width;this.push(g);if(d&&i&&j){e.style.height=i<a?a+"px":"auto";e.style.width=j<a?a+"px":"auto";if(f&&f.tagName=="IMG"&&f.src.match(/.+\.(gif|jpg|png)$/i)){f.style.height=i>2*a?2*a+"px":"auto";f.style.width=j>2*a?2*a+"px":"auto";f.height=i;f.width=j}}}},clear:function(){this.length=0}})}},onHide:function(){c=false},onCancel:function(){b.getContentElement("tab1","inputFile").reset();if(CKEDITOR.env.gecko){CKEDITOR.tools.setTimeout(function(){b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client)},500,this)}else b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client);b.getContentElement("tab1","uploadFile").enable();var c=CKEDITOR.document.getById(b.getContentElement("tab1","inputFile")._.labelId);c.setHtml(a.lang.filebrowser.uploadTip)},onShow:function(){var c={};if(a.plugins.jfilebrowser.params.type)c.type=a.plugins.jfilebrowser.params.type;if(!b.type||!b.path||typeof c.type=="undefined"||!!c.type&&b.type!=c.type||!!c.path&&b.path!=c.path){m();n();CKEDITOR.ajax.loadXml(a.plugins.jfilebrowser._commandUrl(a,"Init",c),r)}b.getContentElement("tab1","inputFile").reset();if(b&&b.type&&b.path){if(CKEDITOR.env.gecko){CKEDITOR.tools.setTimeout(function(){b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client)},500,this)}else b.getContentElement("tab1","inputFile").getInputElement().getParent().setAttribute("action",a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:b.type,currentFolder:b.path})+"&client="+a.config.client)}},contents:[{id:"tab1",label:a.lang.filebrowser.title,accessKey:"B",elements:[{type:"html",html:'<style type="text/css">'+'.cke_folder { background: url("'+CKEDITOR.getUrl(d+"folder.gif")+'"); }'+'.cke_folderOpened{ background: url("'+CKEDITOR.getUrl(d+"folderOpened.gif")+'"); }'+'.cke_folderUp { background: url("'+CKEDITOR.getUrl(d+"folderUp.gif")+'"); }'+".cke_filebrowser .cke_dialog_ui_hbox_first {vertical-align:top;}"+".cke_folder, .cke_folderOpened, .cke_folderUp {"+"padding-left:20px;"+"height:16px;"+"background-repeat:no-repeat;"+"}"+"#cke_actualFolder {"+"font-weight:bold;"+"font-size:120%;"+"}"+"</style>"},{type:"hbox",widths:["140px","540px"],align:"left",padding:0,className:"cke_filebrowser",children:[{type:"vbox",children:[{type:"select",id:"cmbResourceType",accessKey:"R",labelLayout:"vertical",label:a.lang.filebrowser.resourceType,items:[[a.lang.common.notSet,""]],onChange:function(){if(this.isChanged()||c){this.resetInitValue();v(this.getValue(),"/");m()}}},{type:"vbox",id:"folders",style:"display:table-cell;",children:[]}]},{type:"vbox",heights:["","290px"],children:[{type:"hbox",widths:["36px",""],children:[{type:"html",align:"left",style:"vertical-align:middle",html:'<img width="32" height="32" src="'+CKEDITOR.getUrl(d+"folderOpened32.gif")+'" alt=""/>'},{type:"html",style:"vertical-align:middle",html:'<div id="cke_actualFolder"></div>'}]},{type:"vbox",id:"resourceslist",style:"height:290px;white-space: nowrap;",children:[]},{type:"hbox",style:"height:35px;",children:[{type:"file",label:a.lang.filebrowser.uploadTip,labelLayout:"vertical",action:a.plugins.jfilebrowser._commandUrl(a,"FileUpload",{type:"Files",currentFolder:"/"})+"&client="+a.config.client,multiple:true,id:"inputFile",name:"inputFile[]"},{type:"fileButton",label:a.lang.common.uploadSubmit,id:"uploadFile",accessKey:"S",onClick:function(b){var c=this.getDialog(),d=c.getContentElement("tab1","inputFile").getInputElement().$.value;if(!d){alert(a.lang.filebrowser.fileNotSelected);return false}else{if(!c.resourceTypes[c.type].isExtensionAllowed(k(d))){alert(a.lang.filebrowser.errors[a.plugins.jfilebrowser.ERROR_INVALID_EXTENSION]);return false}var e=CKEDITOR.document.getById(c.getContentElement("tab1","inputFile")._.labelId);e.setHtml('Uploading: <img style="bottom:0px;" src="'+a.config.baseHref+'plugins/editors/jckeditor/images/loader.gif" />')}},"for":["tab1","inputFile"]}]}]}]}]}],buttons:[i,CKEDITOR.dialog.cancelButton]}})})()